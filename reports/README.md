# Generating summary system activity reports

Summarizations of a metric from the system activity reports of the EC2 benchmarks
can be generated by following these instructions.

## Download the benchmarks to a small EC2 instance or local machine.
For this purpose I used a `t3.micro` but any machine with simple linux tools,
python3 and an AWS CLI should suffice.
```
aws s3 cp --recursive s3://uchig-genomics-pipeline-us-east-1/benchmarks/ ./
```
This will generate a directory structure containing all benchmarks. Importantly,
these are grouped by workflow and instance type.

## Obtain the desired metric
The system activity reports found in files named `sar.txt.gz`. The are "column"
formatted with each row being one metric at one time point. This means you
can extract the metric of interest from the compressed file for all runs and
all instance types using `zgrep` using a regular expression for the metric of
interest. In this example we are getting the %usr metric for all CPUs. The names
of available metrics are those generated by the systat (`sa`) package.

* CPU
```
zgrep "all.*%usr" */*/*/sar.txt.gz > all_cpu_%usr.txt
```

* Disk used
```
zgrep "nvme1n1.*MBfsused" *NA*/*/*/sar.txt.gz
```

* major faults
```
zgrep "majflt/s" *NA*/*/*/sar.txt.gz
```

* bytes written per second
```
zgrep "bwrtn" *NA*/*/*/sar.txt.gz
```

* bytes read per second
```
zgrep "bread/s" *NA*/*/*/sar.txt.gz
```

* percentage memory used
```
zgrep "%memused" *NA*/*/*/sar.txt.gz
```

* absolute memory used - RAM
```
zgrep "kbmemused" *NA*/*/*/sar.txt.gz
```

*  absolute memory used - RAM + SWAP
```
zgrep "kbcommit" *NA*/*/*/sar.txt.gz
```


## Process the metric
The following python script will process a metric file extracted by the `zgrep`
command, split the file path into components and accumulate the runtime since the
start of the run (for each independent run).

```
python3.7 generate-report.py --input all_cpu_%usr.txt > cpu_%usr_report.txt
```
In its current form the script is limited to one metric per input file although
it wouldn't be hard to modify this.

## Summarize the report
The output of the above python script can be used to generate summary statistics
using the following python script. As before the script assumes one metric per
input file generated by the previous step.

```
python3.7 generate-summary.py --input cpu_%usr_report.txt > cpu_%usr_summary.txt
```

